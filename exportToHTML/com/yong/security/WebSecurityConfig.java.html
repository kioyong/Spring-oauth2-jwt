<html>
<head>
<title>WebSecurityConfig.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: #606366; font-weight: normal; font-style: normal; }
.s0 { color: rgb(89,124,194); }
.s1 { color: rgb(174,181,189); }
.s2 { color: rgb(92,122,184); }
.s3 { color: rgb(122,122,122); font-style: italic; }
.s4 { color: rgb(122,122,122); }
.s5 { color: rgb(128,125,110); font-weight: bold; }
</style>
</head>
<BODY BGCOLOR="#2b2b2b">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
WebSecurityConfig.java</FONT>
</center></TD></TR></TABLE>
<pre>
<span class="s0">package </span><span class="s1">com.yong.security</span><span class="s2">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">com.google.common.base.Throwables</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.yong.security.model.ResponseBean</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.yong.security.repository.UserDao</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.yong.security.service.impl.UserDetailServiceImpl</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">lombok.AllArgsConstructor</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.beans.factory.annotation.Autowired</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.context.annotation.Bean</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.context.annotation.Configuration</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.http.HttpMethod</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.authentication.AuthenticationManager</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.config.http.SessionCreationPolicy</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.core.AuthenticationException</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.core.userdetails.UserDetails</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.core.userdetails.UserDetailsService</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.core.userdetails.UsernameNotFoundException</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.crypto.password.PasswordEncoder</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.web.AuthenticationEntryPoint</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.web.authentication.ForwardAuthenticationFailureHandler</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.web.authentication.ForwardAuthenticationSuccessHandler</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.security.web.util.matcher.AntPathRequestMatcher</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">org.springframework.stereotype.Component</span><span class="s2">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">javax.servlet.ServletException</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">javax.servlet.http.HttpServletRequest</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">javax.servlet.http.HttpServletResponse</span><span class="s2">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.io.IOException</span><span class="s2">;</span><span class="s1"> 
 
</span><span class="s3">/** 
 * Created by LiangYong on 2017/10/1. 
 */</span><span class="s1"> 
 
 
@Configuration 
@EnableWebSecurity 
</span><span class="s0">public class </span><span class="s1">WebSecurityConfig </span><span class="s0">extends </span><span class="s1">WebSecurityConfigurerAdapter { 
 
    @Autowired 
    </span><span class="s0">private </span><span class="s1">UserDetailsService userDetailsService</span><span class="s2">;</span><span class="s1"> 
 
    @Autowired 
    </span><span class="s0">public void </span><span class="s1">configureGlobal(AuthenticationManagerBuilder auth) </span><span class="s0">throws </span><span class="s1">Exception { 
        auth.userDetailsService(userDetailsService)</span><span class="s2">;</span><span class="s1"> 
</span><span class="s4">//        .passwordEncoder(new BCryptPasswordEncoder());</span><span class="s1"> 
    } 
 
    @Override 
    @Bean </span><span class="s4">// share AuthenticationManager for web and oauth</span><span class="s1"> 
    </span><span class="s0">public </span><span class="s1">AuthenticationManager authenticationManagerBean() </span><span class="s0">throws </span><span class="s1">Exception { 
        </span><span class="s0">return super</span><span class="s1">.authenticationManagerBean()</span><span class="s2">;</span><span class="s1"> 
    } 
    </span><span class="s3">/** 
     * 校验规则 
     * **/</span><span class="s1"> 
    @Override 
    </span><span class="s0">protected void </span><span class="s1">configure(HttpSecurity http) </span><span class="s0">throws </span><span class="s1">Exception { 
        http 
                .csrf() 
                .disable()  </span><span class="s4">//禁用csrf保护</span><span class="s1"> 
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)  </span><span class="s4">//禁用session</span><span class="s1"> 
                .and() 
                .authorizeRequests()  </span><span class="s4">//所有请求都要验证</span><span class="s1"> 
                .antMatchers(</span><span class="s5">&quot;/oauth/**&quot;</span><span class="s1">).permitAll()  </span><span class="s4">//登录注册等请求过滤</span><span class="s1"> 
                .antMatchers(HttpMethod.OPTIONS).permitAll() 
                .anyRequest().fullyAuthenticated() 
                .and().formLogin().loginPage(</span><span class="s5">&quot;/&quot;</span><span class="s1">).defaultSuccessUrl(</span><span class="s5">&quot;/index&quot;</span><span class="s1">) 
                .and() 
                .exceptionHandling()  </span><span class="s4">//验证不通过的配置</span><span class="s1"> 
                .authenticationEntryPoint(authenticationEntryPoint())</span><span class="s4">//自己改写response内容</span><span class="s1"> 
</span><span class="s4">//                .and().httpBasic();kjjjjjjjjjjlllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllllll</span><span class="s1"> 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
        $$$R]======================</span><span class="s2">,</span><span class="s1">%tr 
        </span><span class="s2">;</span><span class="s1"> 
        </span><span class="s4">//添加前置过滤器，校验token</span><span class="s1"> 
</span><span class="s4">//        http.addFilterBefore(authenticationTokenFilterBean(), UsernamePasswordAuthenticationFilter.class);</span><span class="s1"> 
        </span><span class="s4">//替换原有的usernamepasswordAuthenticationFilter,使用json登录</span><span class="s1"> 
        http.addFilterAt(customAuthenticationFilterBean()</span><span class="s2">,</span><span class="s1">UsernamePasswordAuthenticationFilter.</span><span class="s0">class</span><span class="s1">)</span><span class="s2">;</span><span class="s1"> 
        </span><span class="s4">//禁用header缓存</span><span class="s1"> 
        http.headers().cacheControl()</span><span class="s2">;</span><span class="s1"> 
    } 
 
    @Bean 
    </span><span class="s0">public </span><span class="s1">AuthenticationEntryPoint authenticationEntryPoint(){ 
        </span><span class="s0">return </span><span class="s1">(HttpServletRequest httpServletRequest</span><span class="s2">, </span><span class="s1">HttpServletResponse response</span><span class="s2">, </span><span class="s1">AuthenticationException e) -&gt;{ 
                    response.setCharacterEncoding(</span><span class="s5">&quot;utf-8&quot;</span><span class="s1">)</span><span class="s2">;</span><span class="s1"> 
</span><span class="s4">//                    response.setHeader(&quot;Content-Type&quot;,&quot;application/json&quot;);</span><span class="s1"> 
                    response.getWriter().write(ResponseBean.error(e).toString())</span><span class="s2">;</span><span class="s1"> 
                }</span><span class="s2">;</span><span class="s1"> 
    } 
    @Bean 
    CustomAuthenticationFilter customAuthenticationFilterBean() </span><span class="s0">throws </span><span class="s1">Exception { 
        CustomAuthenticationFilter filter = </span><span class="s0">new </span><span class="s1">CustomAuthenticationFilter()</span><span class="s2">;</span><span class="s1"> 
        filter.setFilterProcessesUrl(</span><span class="s5">&quot;/login&quot;</span><span class="s1">)</span><span class="s2">;</span><span class="s1"> 
        filter.setAuthenticationSuccessHandler(</span><span class="s0">new </span><span class="s1">ForwardAuthenticationSuccessHandler(</span><span class="s5">&quot;/index&quot;</span><span class="s1">))</span><span class="s2">;</span><span class="s1"> 
        filter.setAuthenticationFailureHandler(</span><span class="s0">new </span><span class="s1">ForwardAuthenticationFailureHandler(</span><span class="s5">&quot;/index&quot;</span><span class="s1">))</span><span class="s2">;</span><span class="s1"> 
        filter.setAuthenticationManager(authenticationManagerBean())</span><span class="s2">;</span><span class="s1"> 
        </span><span class="s0">return </span><span class="s1">filter</span><span class="s2">;</span><span class="s1"> 
    } 
 
} 
</span></pre>
</body>
</html>